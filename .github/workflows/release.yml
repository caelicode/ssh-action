name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install semantic-release
        run: npm install --no-save semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/github conventional-changelog-conventionalcommits

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          BEFORE_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")

          npx semantic-release

          git fetch --tags
          AFTER_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")

          if [ "$BEFORE_TAG" != "$AFTER_TAG" ] && [ "$AFTER_TAG" != "none" ]; then
            echo "new_release_published=true" >> "$GITHUB_OUTPUT"
            echo "new_release_version=${AFTER_TAG#v}" >> "$GITHUB_OUTPUT"
            echo "new_release_tag=$AFTER_TAG" >> "$GITHUB_OUTPUT"
            echo "New release: $AFTER_TAG"
          else
            echo "new_release_published=false" >> "$GITHUB_OUTPUT"
            echo "No new release"
          fi

      # Move the major version tag (v1) to the latest release.
      # This is the GitHub Actions convention — consumers use @v1 and
      # automatically get the latest compatible version.
      - name: Update major version tag
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          RELEASE_TAG: ${{ steps.semantic.outputs.new_release_tag }}
        run: |
          MAJOR=$(echo "$RELEASE_TAG" | grep -oP '^v\d+')
          echo "Moving ${MAJOR} → ${RELEASE_TAG}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete the old major tag (local + remote), then create a new one
          git tag -d "$MAJOR" 2>/dev/null || true
          git push origin ":refs/tags/${MAJOR}" 2>/dev/null || true
          git tag -a "$MAJOR" -m "${MAJOR}: points to ${RELEASE_TAG}" "$RELEASE_TAG"
          git push origin "$MAJOR"

          echo "✅ ${MAJOR} now points to ${RELEASE_TAG}"
